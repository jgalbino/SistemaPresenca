<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Contagem de Presenças por Turma</title>
    <!-- Importa o script do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-auth-compat.js"></script>
    
    <script type="text/javascript">
        // Configuração do Firebase
        var config = {
        	apiKey: "AIzaSyDTVuDV0-cK9Nk6OvRV3IO8f563nPXTjuY",
        	authDomain: "sistemaoctogono.firebaseapp.com",
        	projectId: "sistemaoctogono",
        	storageBucket: "sistemaoctogono.appspot.com",
        	messagingSenderId: "415747300285",
        	appId: "1:415747300285:web:2ae6ae2d51eefc7e1950d4"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(config);
        const db = firebase.firestore();

        // Função para contar presenças por turma
        function contarPresencasPorTurma() {
            db.collection("Presenças")
              .get()
              .then((querySnapshot) => {
                  const contagemPorTurma = {};

                  // Iterar sobre todos os documentos e contar por turma
                  querySnapshot.forEach((doc) => {
                      const turma = doc.data().turma; // Assumindo que o campo "turma"
                      
                      // Se a turma já estiver no objeto, incrementa; se não, inicializa com 1
                      if (contagemPorTurma[turma]) {
                          contagemPorTurma[turma]++;
                      } else {
                          contagemPorTurma[turma] = 1;
                      }
                  });

                  // Criar uma mensagem para o alerta com a contagem por turma
                  let mensagem = "Contagem de presenças por turma:\n";
                  for (const [turma, contagem] of Object.entries(contagemPorTurma)) {
                      mensagem += `Turma ${turma}: ${contagem}\n`;
                  }

                  alert(mensagem); // Exibe o alerta com a contagem por turma
              })
              .catch((error) => {
                  console.error("Erro ao obter a coleção Presenças:", error);
                  alert("Erro ao contar presenças. Veja o console para mais detalhes.");
              });
        }

                function contarPresencasPorNome() {
            // Obter todos os documentos da coleção "Presenças"
            db.collection("Presenças")
              .get()
              .then((querySnapshot) => {
                  const contagemPorAluno = {}; // Para armazenar a contagem por ID do aluno

                  // Iterar sobre cada documento para contar a presença por ID do aluno
                  querySnapshot.forEach((doc) => {
                      const presentes = doc.data().presentes; // Array de IDs dos presentes
                      if (presentes) {
                          presentes.forEach((presentes) => {
                              // Incrementar contagem para cada ID de aluno
                              if (contagemPorAluno[presentes]) {
                                  contagemPorAluno[presentes]++;
                              } else {
                                  contagemPorAluno[presentes] = 1;
                              }
                          });
                      }
                  });

                  // Agora precisamos substituir os IDs pelo nome do aluno
                  const promises = []; // Para armazenar todas as promessas de busca de nomes
                  const contagemPorNome = {}; // Para contagem por nome do aluno

                  // Buscar nomes dos alunos na coleção "Alunos"
                  for (const presentes in contagemPorAluno) {
                      const prom = db.collection("Alunos").doc(presentes).get()
                          .then((doc) => {
                              if (doc.exists) {
                                  const nome = doc.data().nome; // Obter o nome do aluno
                                  const quantidade = contagemPorAluno[presentes]; // Quantidade de presenças por ID

                                  // Se o nome já existe, incrementa; se não, inicializa com a quantidade
                                  if (contagemPorNome[nome]) {
                                      contagemPorNome[nome] += quantidade;
                                  } else {
                                      contagemPorNome[nome] = quantidade;
                                  }
                              }
                          });

                      // Adiciona a promessa à lista para aguardar todas serem concluídas
                      promises.push(prom);
                  }

                  // Esperar todas as promessas de busca de nome serem concluídas
                  Promise.all(promises).then(() => {
                      // Criar uma mensagem para o alerta com a contagem por nome do aluno
                      let mensagem = "Contagem de presenças por nome do aluno:\n";
                      for (const [nome, contagem] of Object.entries(contagemPorNome)) {
                          mensagem += `Aluno ${nome}: ${contagem}\n`;
                      }

                      alert(mensagem); // Exibe o alerta com a contagem por nome
                  });

              })
              .catch((error) => {
                  console.error("Erro ao obter a coleção Presenças:", error);
                  alert("Erro ao contar presenças. Veja o console para mais detalhes.");
              });
        }
        
    </script>
</head>
<body>
    <!-- Botão para contar presenças por turma -->
    <button onclick="contarPresencasPorTurma(),contarPresencasPorNome()">Contar Presenças por Turma</button>
</body>
</html>
